pipeline {
  agent any

  environment {
    DOCKERHUB_USER = credentials('DOCKERHUB_USER')
    DOCKERHUB_PASS = credentials('DOCKERHUB_PASS')
    REPO = "hao1706/ballandbeer"
  }

  stages {
    stage('Clone source') {
      steps {
        checkout scm
      }
    }

    stage('Detect changed services') {
      steps {
        script {
          changedServices = sh(script: '''
            git diff --name-only HEAD~1 HEAD |
            grep -E '^services/|^frontend/' |
            awk -F/ '{print $2}' |
            sort -u
          ''', returnStdout: true).trim().split('\n')

          echo "Changed services: ${changedServices}"
        }
      }
    }

    stage('Build & Push') {
      steps {
        script {
          for (svc in changedServices) {
            def path = (svc == 'frontend') ? 'frontend' : "services/${svc}"
            def image = "${REPO}:${svc}"

            echo "Building ${svc} from ${path}"
            sh "docker build -t ${image} ${path}"

            echo "Pushing ${image} to Docker Hub"
            sh """
              echo "${DOCKERHUB_PASS}" | docker login -u "${DOCKERHUB_USER}" --password-stdin
              docker push ${image}
            """
          }
        }
      }
    }
  }
}
