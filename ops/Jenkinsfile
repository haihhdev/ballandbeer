pipeline {
  agent any

  environment {
    DOCKERHUB_USER = credentials('DOCKERHUB_USER')
    DOCKERHUB_PASS = credentials('DOCKERHUB_PASS')
    REPO = "hao1706/ballandbeer"
    AWS_ACCESS_KEY_ID = credentials('AWS_ACCESS_KEY_ID')
    AWS_SECRET_ACCESS_KEY = credentials('AWS_SECRET_ACCESS_KEY')
    AWS_DEFAULT_REGION = "us-east-1"
    SONARQUBE_SERVER = 'SonarQubeServer'
    SNYK_TOKEN = credentials('SNYK_TOKEN')
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Static Analysis') {
      parallel {
        stage('SonarQube Analysis') {
          steps {
            script {
              def services = ['authen', 'booking', 'order', 'product', 'profile']
              for (svc in services) {
                def path = "services/${svc}"
                withSonarQubeEnv("${SONARQUBE_SERVER}") {
                  withEnv(["PATH+SCANNER=/opt/sonar-scanner/bin"]) {
                    sh """
                      sonar-scanner \
                        -Dsonar.projectKey=ballandbeer-${svc} \
                        -Dsonar.sources=${path} \
                        -Dsonar.host.url=$SONAR_HOST_URL \
                        -Dsonar.login=$SONAR_AUTH_TOKEN
                    """
                  }
                }
              }
            }
          }
        }

        stage('Pre-build Trivy Scan') {
          steps {
            script {
              def services = ['frontend', 'authen', 'booking', 'order', 'product', 'profile']
              for (svc in services) {
                def path = (svc == 'frontend') ? 'frontend' : "services/${svc}"
                echo "Scanning source in ${path} with Trivy..."
                sh """
                  trivy fs --exit-code 0 --severity HIGH,CRITICAL ${path} || true
                """
              }
            }
          }
        }

        stage('Snyk Code Scan') {
          steps {
            script {
              sh "snyk auth $SNYK_TOKEN"
              def services = ['frontend', 'authen', 'booking', 'order', 'product', 'profile']
              for (svc in services) {
                def path = (svc == 'frontend') ? 'frontend' : "services/${svc}"
                echo "Running Snyk code scan on ${path}..."
                sh """
                  cd ${path}
                  snyk test || true
                  snyk monitor || true
                """
              }
            }
          }
        }
      }
    }

    stage('Build & Push Images') {
      steps {
        script {
          def timestamp = sh(script: "date +%Y%m%d%H%M", returnStdout: true).trim()
          def servicePorts = [
            authen : 4000,
            booking: 4001,
            order  : 4002,
            product: 4003,
            profile: 4004,
            rcm_fastapi: 4005
          ]

          withCredentials([file(credentialsId: 'ENV_TEMPLATE', variable: 'ENV_TEMPLATE')]) {
            def services = ['frontend', 'authen', 'booking', 'order', 'product', 'profile', 'rcm_fastapi']
            for (svc in services) {
              def path = (svc == 'frontend') ? 'frontend' : "services/${svc}"
              def imageTag = "${svc}-${timestamp}"
              def serviceRepo = "hao1706/${svc}"
              def imageWithTimestamp = "${serviceRepo}:${timestamp}"
              def imageLatest = "${serviceRepo}:latest"

              echo "Building ${svc} from ${path}..."

              if (svc == 'frontend') {
                sh """
                  rm -f ${path}/.env.local.build
                  install -m 644 \$ENV_TEMPLATE ${path}/.env.local.build
                """
              } else if (servicePorts.containsKey(svc)) {
                def port = servicePorts[svc]
                sh """
                  rm -f ${path}/.env
                  install -m 644 \$ENV_TEMPLATE ${path}/.env
                  sed -i 's/_PORT_/${port}/' ${path}/.env
                """
              }

              sh "docker build -t ${imageWithTimestamp} -t ${imageLatest} ${path}"

              if (svc == 'frontend') {
                sh "rm -f ${path}/.env.local.build"
              } else {
                sh "rm -f ${path}/.env"
              }

              echo "Pushing ${svc} images to Docker Hub..."
              sh '''
                echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USER" --password-stdin
              '''
              sh "docker push ${imageWithTimestamp}"
              sh "docker push ${imageLatest}"

              sh "echo ${timestamp} > ${svc}_tag.txt"
            }
          }
        }
      }
    }

    stage('Post-build Security Scans') {
      parallel {
        stage('Trivy Image Scan') {
          steps {
            script {
              def services = ['frontend', 'authen', 'booking', 'order', 'product', 'profile']
              for (svc in services) {
                def imageTag = readFile("${svc}_tag.txt").trim()
                def serviceRepo = "hao1706/${svc}"
                def image = "${serviceRepo}:${imageTag}"
                echo "Scanning image ${image} with Trivy..."
                sh "trivy image --exit-code 0 --severity HIGH,CRITICAL ${image} || true"
              }
            }
          }
        }

        stage('Snyk Image Scan') {
          steps {
            script {
              sh "snyk auth $SNYK_TOKEN"
              def services = ['frontend', 'authen', 'booking', 'order', 'product', 'profile']
              for (svc in services) {
                def imageTag = readFile("${svc}_tag.txt").trim()
                def serviceRepo = "hao1706/${svc}"
                def image = "${serviceRepo}:${imageTag}"
                echo "Running Snyk container scan on ${image}..."
                sh """
                  snyk container test ${image} || true
                  snyk monitor || true
                """
              }
            }
          }
        }
      }
    }
  }
}
